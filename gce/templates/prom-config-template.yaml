#cloud-config
---
write_files:
  # Network config file for the Calico CNI plugin.
  - path: /etc/prometheus.yml
    owner: root
    permissions: 0655
    content: |
      scrape_configs:
      - job_name: felix
        scrape_interval: 10s
        target_groups:
        - targets: __FELIXES__
        - targets: ["__CLUSTER_PREFIX__-master:9091"]
      - job_name: etcd-driver
        scrape_interval: 10s
        target_groups:
        - targets: __DRIVERS__
        - targets: ["__CLUSTER_PREFIX__-master:9092"]
      - job_name: etcd
        scrape_interval: 10s
        target_groups:
        - targets: __PROM_ETCD_ENDPOINTS__
      - job_name: host
        scrape_interval: 10s
        target_groups:
        - targets: __PROM_HOSTS__
        - targets: __PROM_ETCD_HOST_ENDPOINTS__
        - targets: ["__CLUSTER_PREFIX__-master:9100", "__CLUSTER_PREFIX__-prom:9100"]

coreos:

  fleet:
    metadata: "role=node"
    etcd_servers: "http://127.0.0.1:2379"
  update:
    reboot-strategy: off
  units:
    - name: "docker.service"
      drop-ins:
        - name: "50-insecure-registry.conf"
          content: |
            [Service]
            Environment=DOCKER_OPTS='--insecure-registry="__CLUSTER_PREFIX__-master:5000"'
    - name: fleet.service
      command: start
    - name: prom.service
      command: start
      content: |
        [Unit]
        Description=Prometheus
        Requires=docker.service
        After=docker.service

        [Service]
        TimeoutStartSec=0
        ExecStartPre=/usr/bin/wget -N -P /etc/ __PROMETHEUS_CONFIG_URL__
        ExecStart=/usr/bin/docker run --rm --name prometheus -p 9090:9090 \
                  -v /etc/prometheus.yml:/etc/prometheus.yml \
                  prom/prometheus \
                  -config.file=/etc/prometheus.yml

        [Install]
        WantedBy=multi-user.target
    - name: node-exporter.service
      command: start
      content: |
        [Unit]
        Description=Prometheus node statistics exporter
        After=docker.service
        Requires=docker.service
        [Service]
        ExecStart=/usr/bin/docker run --rm --name node-exporter -p 9100:9100 --net="host" prom/node-exporter
        Restart=always
        RestartSec=10
